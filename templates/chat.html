<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - Legal Guidance App</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('/static/images/blur.png') no-repeat center center fixed;
      background-size: cover;
      background-color: black;
      color: white;
      text-align: center;
      margin-top: 100px;
    }
    .navbar {
      background-color: #3a2307;
      height: 60px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.2);
      padding: 30px;
      border-radius: 10px;
      width: 600px;
      margin: auto;
    }
    .chat-box {
      background-color: #95937c;
      border-radius: 20px;
      padding: 10px;
      height: 300px;
      width: 95%;
      max-width: 800px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .user-message {
      background-color: #95937c;
      color: white;
      text-align: right;
      margin: 5px 0;
      padding: 8px;
      border-radius: 10px;
    }
    .bot-message {
      background-color: #b88f5d;
      color: black;
      text-align: left;
      margin: 5px 0;
      padding: 8px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bot-message span {
      flex-grow: 1;
      text-align: left;
    }
    .speak-button {
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 50%;
      padding: 5px 8px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    .speak-button:hover {
      background-color: #ddd;
    }
    button {
      background-color: #80581d;
      color: black;
      border: none;
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3a2307;
    }
    input {
      padding: 10px;
      width: 70%;
      border-radius: 8px;
      border: none;
    }

    /* Loading animation */
    .loading {
      margin: 10px;
      font-size: 18px;
      color: #b88f5d;
    }
    .loading:after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand ms-3" href="#">LawXpert</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto me-3">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/about">About Us</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('chat') }}">Chat</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('community') }}">Community</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </div>
  </nav>

  <h1>Welcome to LawXpert Chat</h1>
  
  <div class="container">
    <div class="chat-box" id="chat-box">
      <div class="bot-message">
        <span>Hello! Welcome to the Legal Guidance Chat. How can I assist you today?</span>
        <button class="speak-button" onclick="speak('Hello! Welcome to the Legal Guidance Chat. How can I assist you today?')">🔊</button>
      </div>
      <button onclick="selectOption('Legal Advice')">Legal Advice</button>
      <button onclick="selectOption('Case Status')">Check Case Status</button>
      <button onclick="selectOption('Lawyer Connect')">Connect with a Lawyer</button>
    </div>

    <input type="text" id="message-input" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
      let synth = window.speechSynthesis;
      let currentUtterance = null;
      let isPaused = false;
    
      function isDevanagari(text) {
        // Check if text has Devanagari unicode characters
        return /[\u0900-\u097F]/.test(text);
      }
    
      function speak(text) {
        if (synth.speaking) {
          if (isPaused) {
            synth.resume();
            isPaused = false;
          } else {
            synth.pause();
            isPaused = true;
          }
          return;
        }
    
        currentUtterance = new SpeechSynthesisUtterance(text);
    
        if (isDevanagari(text)) {
          currentUtterance.lang = 'hi-IN';  // Hindi voice for Devanagari text
        } else {
          currentUtterance.lang = 'en-US';  // English otherwise
        }
    
        currentUtterance.onend = () => {
          isPaused = false;
        };
    
        synth.speak(currentUtterance);
      }
      function addBotMessage(message) {
          displayMessage(message, 'bot');
      }
    function displayMessage(text, type) {
      const chatBox = document.getElementById('chat-box');
      const messageElement = document.createElement('div');
      messageElement.classList.add(type === 'user' ? 'user-message' : 'bot-message');

      if (type === 'bot') {
        const messageText = document.createElement('span');
        messageText.innerText = text;

        const speakButton = document.createElement('button');
        speakButton.innerText = '🔊';
        speakButton.classList.add('speak-button');
        speakButton.onclick = () => speak(text);

        messageElement.appendChild(messageText);
        messageElement.appendChild(speakButton);
      } else {
        messageElement.innerText = text;
      }

      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    
    function selectOption(option) {
      const chatBox = document.getElementById('chat-box');
      const userMessage = document.createElement('div');
      userMessage.classList.add('user-message');
      userMessage.innerText = `You selected: ${option}`;
      chatBox.appendChild(userMessage);

      if (option === 'Legal Advice') {
        addBotMessage('Please describe your legal issue briefly.');
      } else if (option === 'Case Status') {
        addBotMessage('Please enter your case ID to proceed.');
      } else if (option === 'Lawyer Connect') {
        displayLawyerOptions();
      }
    }


    function showLawyerDescriptions() {
      const descriptions = {
        'Civil Lawyer': 'Handles non-criminal matters such as property disputes and contract issues.',
        'Criminal Lawyer': 'Represents individuals accused of crimes.',
        'Family Lawyer': 'Deals with matters like divorce and child custody.',
        'Corporate Lawyer': 'Provides legal support to businesses.',
        'Immigration Lawyer': 'Assists with visas and citizenship applications.'
      };

      for (const [lawyer, desc] of Object.entries(descriptions)) {
        addBotMessage(`🟢 ${lawyer}: ${desc}`);
      }
    }
function connectToLawyer(lawyerType) {
  
  console.log("Sending lawyer type:", lawyerType); // 🐞 debug line
  const validLawyerTypes = ['Civil', 'Criminal', 'Family', 'Corporate', 'Immigration'];

  if (!validLawyerTypes.includes(lawyerType)) {
    addBotMessage('Invalid lawyer type selected. Please choose a valid option.');
    return;
  }

  addBotMessage(`You have chosen to connect with a ${lawyerType} lawyer. Please wait while we connect you.`);

  addLoadingIndicator();

  fetch('/connect_lawyer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `lawyer_type=${encodeURIComponent(lawyerType)}`
  })
    .then(response => response.text())
    .then(data => {
      removeLoadingIndicator();
      addBotMessage(data);
    })
    .catch(error => {
      removeLoadingIndicator();
      addBotMessage(`Error connecting to lawyer: ${error}`);
    });
}


function displayLawyerOptions() {
  const chatBox = document.getElementById('chat-box');

  // Clear existing buttons if any
  const existingButtons = chatBox.querySelectorAll('button.lawyer-option');
  existingButtons.forEach(btn => btn.remove());

  addBotMessage('Please select the type of lawyer you wish to connect with, or click "Help Me Choose" for guidance:');

  const lawyerOptions = [
    { label: 'Civil Lawyer', value: 'Civil' },
    { label: 'Criminal Lawyer', value: 'Criminal' },
    { label: 'Family Lawyer', value: 'Family' },
    { label: 'Corporate Lawyer', value: 'Corporate' },
    { label: 'Immigration Lawyer', value: 'Immigration' },
  ];

  lawyerOptions.forEach(option => {
    const button = document.createElement('button');
    button.className = 'lawyer-option';
    button.innerText = option.label;
    button.onclick = function () {
      connectToLawyer(option.value); // this is the value sent to Flask
    };
    chatBox.appendChild(button);
  });

  const helpButton = document.createElement('button');
  helpButton.className = 'lawyer-option';
  helpButton.innerText = 'Help Me Choose';
  helpButton.onclick = showLawyerDescriptions;
  chatBox.appendChild(helpButton);
}



    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      if (!message) return;
    
      displayMessage(message, 'user');
      input.value = '';
    
      // Display loading animation
      addLoadingIndicator();
    
      fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `message=${encodeURIComponent(message)}`
      })
      .then(response => response.json())
      .then(data => {
        removeLoadingIndicator();
        if (data.ai_response) {
          displayMessage(data.ai_response, 'bot');
        } else {
          displayMessage('Error: Unable to fetch response.', 'bot');
        }
      })
      .catch(error => {
        removeLoadingIndicator();
        displayMessage(`Error: ${error}`, 'bot');
      });
    }

    
    // Show loading animation
    function addLoadingIndicator() {
      const chatBox = document.getElementById('chat-box');
      const loadingElement = document.createElement('div');
      loadingElement.classList.add('loading');
      loadingElement.id = 'loading-indicator';
      loadingElement.innerText = 'Bot is typing';
      chatBox.appendChild(loadingElement);
    }

    // Remove loading animation
    function removeLoadingIndicator() {
      const loadingElement = document.getElementById('loading-indicator');
      if (loadingElement) {
        loadingElement.remove();
      }
    }

let chatWithUserId = null;  // Set this when user selects a lawyer

function sendUserMessage() {
  const message = document.getElementById('message-input').value;
  fetch('/send_user_message', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: `receiver_id=${chatWithUserId}&message=${encodeURIComponent(message)}`
  })
  .then(() => {
    document.getElementById('message-input').value = '';
    fetchMessages();  // Refresh chat
  });
}

function fetchMessages() {
  if (!chatWithUserId) return;
  fetch(`/get_messages?chat_with=${chatWithUserId}`)
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      data.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = msg.sender_id == USER_ID ? 'user-message' : 'bot-message';
        div.innerText = msg.content;
        box.appendChild(div);
      });
    });
}

// Call fetchMessages every 3 seconds
setInterval(fetchMessages, 3000);

  </script>

  <div class="disclaimer mt-4">
    Disclaimer: This app is created solely for informational purposes and provides general legal information. Please consult a qualified lawyer for specific legal advice before taking any action.
  </div>
</body>
</html>